name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/**'
      - 'ct.yaml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Run chart-testing (lint)
        run: ct lint --config ct.yaml --charts charts/logward

  # NOTE: Test job disabled until Docker images are published to ghcr.io
  # test:
  #   runs-on: ubuntu-latest
  #   needs: lint
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #
  #     - name: Set up Helm
  #       uses: azure/setup-helm@v3
  #       with:
  #         version: v3.13.0
  #
  #     - name: Create kind cluster
  #       uses: helm/kind-action@v1
  #
  #     - name: Install chart
  #       run: |
  #         helm install logward ./charts/logward \
  #           --namespace logward \
  #           --create-namespace \
  #           --set timescaledb.auth.password=testpassword \
  #           --set timescaledb.auth.postgresPassword=testpassword \
  #           --set redis.auth.password=testpassword \
  #           --wait \
  #           --timeout 5m
  #
  #     - name: Verify installation
  #       run: |
  #         kubectl get pods -n logward
  #         kubectl get svc -n logward

  release:
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Create gh-pages branch if not exists
        run: |
          if ! git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "Creating gh-pages branch..."
            git checkout --orphan gh-pages
            git rm -rf .
            echo "# LogWard Helm Charts" > README.md
            git add README.md
            git commit -m "Initial gh-pages branch"
            git push origin gh-pages
            git checkout main
          fi

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.13.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Add artifacthub-repo.yml to gh-pages
        run: |
          git checkout gh-pages
          cp ${{ github.workspace }}/artifacthub-repo.yml . 2>/dev/null || curl -sL https://raw.githubusercontent.com/${{ github.repository }}/main/artifacthub-repo.yml -o artifacthub-repo.yml
          if [ -f artifacthub-repo.yml ]; then
            git add artifacthub-repo.yml
            git diff --staged --quiet || git commit -m "Add artifacthub-repo.yml for verified publisher"
            git push origin gh-pages
          fi
          git checkout main
